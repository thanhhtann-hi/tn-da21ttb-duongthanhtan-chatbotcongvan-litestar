<!-- üìÅ src/modules/auth/templates/auth/verify/verify_fragment.html -->
<!-- üïí Last updated: 2025-07-08 00:55 ‚Äî Th√™m CSRF input & hx-vals -->
{% block form %}
<title hx-swap-oob="true">TvuMoE - X√°c minh email</title>

{% if verified %}
<section class="space-y-5 px-6 text-[90%]">
    <!-- ƒë√£ verify, ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o -->
    <h2 class="text-2xl font-semibold text-green-700 text-center">
        B·∫°n ƒë√£ x√°c minh Email r·ªìi!
    </h2>
    <p class="text-sm text-gray-600 text-center leading-relaxed">
        Vui l√≤ng quay l·∫°i trang ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.
    </p>
    <div class="text-center text-sm space-y-1">
        <a href="/auth/login" class="text-blue-600 hover:underline">ƒêƒÉng nh·∫≠p</a>
    </div>
</section>
{% else %}
<section class="space-y-6 px-6 text-center text-[90%]">

    <h2 class="text-3xl font-semibold leading-snug">
        Ki·ªÉm tra h·ªôp th∆∞<br>c·ªßa b·∫°n
    </h2>

    <p class="text-gray-600 max-w-xs mx-auto">
        Vui l√≤ng nh·∫≠p m√£&nbsp;6&nbsp;s·ªë ch√∫ng t√¥i v·ª´a g·ª≠i ƒë·∫øn
        <b class="text-[#053484]">{{ email }}</b>
    </p>

    <!-- ‚ñ∏ Form nh·∫≠p m√£ -->
    <form id="code-form" class="space-y-4 max-w-xs mx-auto" hx-post="/auth/verify" hx-target="#msg" hx-swap="none">
        <!-- üîê CSRF token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <input type="hidden" name="uid" value="{{ uid }}" />
        <input type="hidden" name="email" value="{{ email }}" />

        <input name="code" maxlength="6" minlength="6" pattern="\d{6}" required placeholder="M√£ 6 s·ªë"
            class="w-full rounded-full border border-gray-300 px-5 py-3 text-center tracking-widest focus:border-[#053484] focus:outline-none" />
        <button id="confirm-btn" class="w-full rounded-full bg-black py-3 text-white hover:opacity-90">
            X√°c nh·∫≠n
        </button>
    </form>

    <!-- ‚ñ∏ G·ª≠i l·∫°i m√£ -->
    {% set disabled = wait|default(60)|int > 0 %}
    <button id="resend-btn"
        class="text-sm text-[#053484] hover:underline {% if disabled %}opacity-50 cursor-not-allowed{% endif %}" {% if
        disabled %}disabled{% endif %} hx-post="/auth/resend-code"
        hx-vals='{"uid":"{{ uid }}","email":"{{ email }}","csrf_token":"{{ csrf_token }}"}' hx-swap="none">
        {% if disabled %}
        G·ª≠i l·∫°i m√£&nbsp;(<span id="cd">{{ wait|default(60)|int }}</span>s)
        {% else %}
        G·ª≠i l·∫°i m√£
        {% endif %}
    </button>

    <!-- ‚ñ∏ Th√¥ng b√°o l·ªói -->
    <div id="msg" class="text-red-600 text-sm mt-1"></div>

    <footer class="text-center text-xs text-gray-500 pt-4">
        <a href="/legal/terms" class="hover:underline">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
        <span class="mx-2 select-none">|</span>
        <a href="/legal/privacy" class="hover:underline">Ch√≠nh s√°ch ri√™ng t∆∞</a>
    </footer>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // ===== ƒê·∫øm ng∆∞·ª£c ban ƒë·∫ßu
    (() => {
        const btn = document.getElementById('resend-btn');
        let s = +('{{ wait|default(60) }}');
        if (!btn || s <= 0 || !btn.hasAttribute('disabled')) return;

        const cd = document.getElementById('cd');
        const tick = () => {
            cd.textContent = s--;
            if (s >= 0) return setTimeout(tick, 1000);
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.removeAttribute('disabled');
            btn.textContent = 'G·ª≠i l·∫°i m√£';
        };
        tick();
    })();

    // ===== X·ª≠ l√Ω ph·∫£n h·ªìi HTMX
    document.body.addEventListener('htmx:afterRequest', (e) => {
        const xhr = e.detail.xhr;

        // ‚ñ∏ Form nh·∫≠p m√£
        if (e.detail.elt.id === 'code-form') {
            const msgEl = document.getElementById('msg');
            msgEl.textContent = xhr.responseText || '';
            if (xhr.getResponseHeader('X-Locked') === 'true' ||
                xhr.getResponseHeader('X-Expired') === 'true') {
                disableConfirm();
            }
            return;
        }

        // ‚ñ∏ G·ª≠i l·∫°i m√£ th√†nh c√¥ng
        if (e.detail.elt.id === 'resend-btn' && xhr.status === 202) {
            enableConfirm();
            document.getElementById('msg').textContent = '';

            let wait = +xhr.getResponseHeader('X-Wait-Seconds') || 60;
            const btn = document.getElementById('resend-btn');
            btn.setAttribute('disabled', '');
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = `G·ª≠i l·∫°i m√£&nbsp;(<span id="cd">${wait}</span>s)`;

            const cdSpan = btn.querySelector('#cd');
            const tick = () => {
                cdSpan.textContent = wait--;
                if (wait >= 0) return setTimeout(tick, 1000);
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.removeAttribute('disabled');
                btn.textContent = 'G·ª≠i l·∫°i m√£';
            };
            tick();
        }
    });

    // ===== Helpers
    function disableConfirm() {
        const inp = document.querySelector('#code-form input[name="code"]');
        const btn = document.getElementById('confirm-btn');
        if (inp) inp.disabled = true;
        if (btn) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function enableConfirm() {
        const inp = document.querySelector('#code-form input[name="code"]');
        const btn = document.getElementById('confirm-btn');
        if (inp) {
            inp.disabled = false;
            inp.value = '';
        }
        if (btn) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
</script>
{% endblock %}